import React, { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Undo2, Activity } from 'lucide-react';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';

const BabyKickTracker = () => {
  // State management
  const [kicks, setKicks] = useState([]);
  const [historicalData, setHistoricalData] = useState({});
  
  // Load data from localStorage on component mount
  useEffect(() => {
    const savedKicks = localStorage.getItem('kicks');
    const savedHistory = localStorage.getItem('kickHistory');
    
    if (savedKicks) setKicks(JSON.parse(savedKicks));
    if (savedHistory) setHistoricalData(JSON.parse(savedHistory));
  }, []);
  
  // Save data to localStorage whenever it changes
  useEffect(() => {
    localStorage.setItem('kicks', JSON.stringify(kicks));
  }, [kicks]);
  
  useEffect(() => {
    localStorage.setItem('kickHistory', JSON.stringify(historicalData));
  }, [historicalData]);
  
  // Helper functions
  const getCurrentDate = () => {
    return new Date().toISOString().split('T')[0];
  };
  
  const getTimeString = (date) => {
    return new Date(date).toLocaleTimeString();
  };
  
  const calculateStats = (kickArray) => {
    if (!kickArray || kickArray.length === 0) return null;
    
    const intervals = [];
    for (let i = 1; i < kickArray.length; i++) {
      intervals.push((new Date(kickArray[i]) - new Date(kickArray[i-1])) / 1000); // in seconds
    }
    
    const movingAverage = kickArray.length >= 10 
      ? (new Date(kickArray[kickArray.length - 1]) - new Date(kickArray[kickArray.length - 10])) / (9 * 1000)
      : null;
    
    return {
      total: kickArray.length,
      movingAverage: movingAverage,
      shortestInterval: Math.min(...intervals) || null,
      longestInterval: Math.max(...intervals) || null,
      averageInterval: intervals.length ? intervals.reduce((a, b) => a + b) / intervals.length : null
    };
  };
  
  // Event handlers
  const handleKick = () => {
    const newKicks = [...kicks, new Date().toISOString()];
    setKicks(newKicks);
    
    // Update historical data
    const currentDate = getCurrentDate();
    setHistoricalData(prev => ({
      ...prev,
      [currentDate]: calculateStats(newKicks)
    }));
  };
  
  const handleUndo = () => {
    if (kicks.length === 0) return;
    
    const newKicks = kicks.slice(0, -1);
    setKicks(newKicks);
    
    // Update historical data
    const currentDate = getCurrentDate();
    setHistoricalData(prev => ({
      ...prev,
      [currentDate]: calculateStats(newKicks)
    }));
  };
  
  const currentStats = calculateStats(kicks);
  
  return (
    <div className="max-w-4xl mx-auto p-4 space-y-6">
      {/* Main Kick Button */}
      <div className="flex flex-col items-center space-y-4">
        <Button 
          className="w-48 h-48 rounded-full text-2xl" 
          onClick={handleKick}
        >
          Record Kick
        </Button>
        <Button
          variant="outline"
          className="flex items-center space-x-2"
          onClick={handleUndo}
          disabled={kicks.length === 0}
        >
          <Undo2 className="w-4 h-4" />
          <span>Undo Last Kick</span>
        </Button>
      </div>

      {/* Today's Stats */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center space-x-2">
            <Activity className="w-5 h-5" />
            <span>Today's Stats</span>
          </CardTitle>
        </CardHeader>
        <CardContent>
          {currentStats ? (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div>
                <p className="text-sm text-gray-500">Total Kicks</p>
                <p className="text-2xl font-bold">{currentStats.total}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500">Moving Average (10 kicks)</p>
                <p className="text-2xl font-bold">
                  {currentStats.movingAverage ? `${Math.round(currentStats.movingAverage)}s` : 'N/A'}
                </p>
              </div>
              <div>
                <p className="text-sm text-gray-500">Average Interval</p>
                <p className="text-2xl font-bold">
                  {currentStats.averageInterval ? `${Math.round(currentStats.averageInterval)}s` : 'N/A'}
                </p>
              </div>
              <div>
                <p className="text-sm text-gray-500">Last Kick</p>
                <p className="text-2xl font-bold">
                  {kicks.length > 0 ? getTimeString(kicks[kicks.length - 1]) : 'N/A'}
                </p>
              </div>
            </div>
          ) : (
            <Alert>
              <AlertDescription>
                No kicks recorded today. Press the button above to start tracking!
              </AlertDescription>
            </Alert>
          )}
        </CardContent>
      </Card>

      {/* Historical Data */}
      <Card>
        <CardHeader>
          <CardTitle>Historical Data</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="overflow-x-auto">
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Date</TableHead>
                  <TableHead className="text-right">Total Kicks</TableHead>
                  <TableHead className="text-right">Avg Interval</TableHead>
                  <TableHead className="text-right">Moving Avg</TableHead>
                  <TableHead className="text-right">Shortest</TableHead>
                  <TableHead className="text-right">Longest</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {Object.entries(historicalData)
                  .sort((a, b) => new Date(b[0]) - new Date(a[0]))
                  .map(([date, stats]) => (
                    <TableRow key={date}>
                      <TableCell>{new Date(date).toLocaleDateString()}</TableCell>
                      <TableCell className="text-right">{stats.total}</TableCell>
                      <TableCell className="text-right">
                        {stats.averageInterval ? `${Math.round(stats.averageInterval)}s` : 'N/A'}
                      </TableCell>
                      <TableCell className="text-right">
                        {stats.movingAverage ? `${Math.round(stats.movingAverage)}s` : 'N/A'}
                      </TableCell>
                      <TableCell className="text-right">
                        {stats.shortestInterval ? `${Math.round(stats.shortestInterval)}s` : 'N/A'}
                      </TableCell>
                      <TableCell className="text-right">
                        {stats.longestInterval ? `${Math.round(stats.longestInterval)}s` : 'N/A'}
                      </TableCell>
                    </TableRow>
                  ))}
              </TableBody>
            </Table>
          </div>
        </CardContent>
      </Card>
    </div>
  );
};

export default BabyKickTracker;
